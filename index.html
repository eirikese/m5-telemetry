<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>TrollSports Live v1.5.0 (2025-08-25)</title>
<meta name="theme-color" content="#0b1220"/>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
  :root{--bg:#0b1220;--card:#0f1a31;--muted:#92a1bd;--text:#e6eefc;--accent:#4cc9f0;--border:#223050;--rec:#ff4d4d}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,sans-serif;padding-bottom:env(safe-area-inset-bottom)}
  .topbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:10px;padding:calc(8px + env(safe-area-inset-top)) 12px 8px;background:linear-gradient(180deg,#0a1120,#0c1526);border-bottom:1px solid var(--border)}
  .app-title{font-weight:700}.spacer{flex:1}.ver{color:var(--muted);font-size:12px}
  .tabs{display:flex;gap:6px}.tabbtn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#0f1a31;color:var(--text);cursor:pointer;font-weight:600}
  .tabbtn.active{background:#152341;border-color:#2a3c64}
  .wrap{padding:12px;display:flex;flex-direction:column;gap:12px}.row{display:flex;gap:12px;flex-wrap:wrap;align-items:stretch}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 1px 10px rgba(0,0,0,.2)}
  .grow{flex:1 1 560px}.half{flex:1 1 320px;min-width:300px}
  .small{font-size:12px;color:var(--muted)} .tiny{font-size:11px;color:var(--muted)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .num{font-weight:700;font-size:clamp(22px,5.8vw,34px);line-height:1.15}
  .btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px} button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#152341;color:#fff;cursor:pointer}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0e1730;color:#fff}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}.hidden{display:none}.ok{color:#6bd66b}.bad{color:#ff6b6b}
  .log{font-size:12px;background:#0a1022;color:#b7c3ff;padding:10px;border-radius:10px;max-height:200px;overflow:auto;border:1px dashed #253356}
  .plot{position:relative;height:45vh;min-height:280px;width:100%} canvas{display:block}
  .recording{background:#4a1111;border-color:#ff7a7a;color:#fff}.recording::before{content:"● ";color:var(--rec)}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,77,77,.85)}70%{box-shadow:0 0 0 12px rgba(255,77,77,0)}100%{box-shadow:0 0 0 0 rgba(255,77,77,0)}}
  .blink{animation:pulse 1s infinite}
  .range-row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center} input[type="range"]{width:100%;accent-color:var(--accent)}
  .unitNow,.unitStats{border-radius:10px;padding:10px;border:1px solid var(--border);background:#0e1730}
  .unitTag{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700;margin-bottom:6px;color:#000}
  .uNums .num{color:var(--ucolor)}
  #map{height:40vh;min-height:260px;border-radius:12px;overflow:hidden}
  .leaflet-container{background:#0b1220}
</style>
<script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
</head>
<body>
  <div class="topbar">
    <div class="app-title">TrollSports Live</div><div class="spacer"></div>
    <div class="ver">v1.5.0 (2025-08-25)</div>
    <div class="tabs">
      <button class="tabbtn active" data-tab="plot">Plot</button>
      <button class="tabbtn" data-tab="stats">Stats</button>
      <button class="tabbtn" data-tab="settings">Settings</button>
    </div>
  </div>

  <!-- Gate -->
  <div id="gate" class="wrap">
    <div class="card half">
      <div style="font-weight:700;margin-bottom:8px;">Protected dashboard</div>
      <div class="small">Enter site password to unlock. Viewer creds are decrypted in-browser (read-only).</div>
      <label>Site password</label><input id="pw" type="password" placeholder="Enter password"/>
      <div class="btns"><button id="btnUnlock">Unlock</button></div>
      <div id="unlockMsg" class="small"></div>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="wrap hidden">
    <!-- PLOT TAB -->
    <section id="tab-plot">
      <div class="row">
        <div class="card grow"><div class="plot"><canvas id="chart_ts"></canvas></div></div>
        <div class="card half" id="nowPanel">
          <div style="font-weight:700;margin-bottom:8px;">Now</div>
          <div id="nowUnits" class="grid" style="margin-top:10px;grid-template-columns:1fr;gap:12px"></div>
          <div class="btns" style="margin-top:12px">
            <button id="btnRecord">Start Recording</button>
            <div class="small" id="recInfo" style="align-self:center;margin-left:6px;"></div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="card grow">
          <div style="font-weight:700;margin-bottom:8px;">GNSS Map</div>
          <div id="map"></div>
          <div class="small" style="margin-top:6px;">Basemap © OpenStreetMap, © CARTO — Dark Matter</div>
        </div>
        <div class="card half">
          <div style="font-weight:700;margin-bottom:8px;">SOG (knots)</div>
          <div class="plot" style="height:40vh;min-height:260px;"><canvas id="chart_sog"></canvas></div>
          <div class="small" id="sogInfo" style="margin-top:6px;"></div>
        </div>
      </div>
    </section>

    <!-- STATS TAB -->
    <section id="tab-stats" class="hidden"><div class="row" id="statsUnits" style="width:100%"></div></section>

    <!-- SETTINGS TAB -->
    <section id="tab-settings" class="hidden">
      <div class="row">
        <div class="card half">
          <div style="font-weight:700;margin-bottom:8px;">Connection</div>
          <div class="grid">
            <div><label>Host</label><input id="host" value="afe7881f82fe42929e4a5370cddc7285.s1.eu.hivemq.cloud"/></div>
            <div><label>WS Port</label><input id="port" value="8884"/></div>
            <div><label>Path</label><input id="path" value="/mqtt"/></div>
            <div><label>Topic</label><input id="topic" value="m5/+/telemetry"/></div>
            <div><label>Client ID (auto)</label><input id="cid" readonly/></div>
            <div><label>Auto-connect after unlock</label><input id="autoconn" type="checkbox" checked/></div>
          </div>
          <div class="small" style="margin-top:8px;">
            Status: <span id="status" class="bad">disconnected</span><br/>
            WSS: <span id="url" class="tiny mono" style="word-break:break-all;"></span>
          </div>
          <div class="btns" style="margin-top:8px">
            <button id="btnConnect">Connect</button>
            <button id="btnDisconnect">Disconnect</button>
            <button id="btnClear">Clear Data</button>
          </div>
        </div>

        <div class="card half">
          <div style="font-weight:700;margin-bottom:8px;">Windows & Peaks</div>
          <div class="grid">
            <div style="grid-column:1/-1;">
              <label>Timeseries View Window (seconds)</label>
              <div class="range-row">
                <input id="viewSecRange" type="range" min="5" max="600" step="5" value="10"/>
                <input id="viewSec" type="number" min="5" max="600" step="5" value="10" style="width:90px"/>
              </div>
            </div>
            <div style="grid-column:1/-1;">
              <label>Analysis Window (seconds) — stats & peak detection</label>
              <div class="range-row">
                <input id="winSecRange" type="range" min="5" max="600" step="5" value="10"/>
                <input id="winSec" type="number" min="5" max="600" step="5" value="10" style="width:90px"/>
              </div>
            </div>
            <div><label>Min peak distance (ms)</label><input id="minDist" value="300"/></div>
            <div><label>Min prominence (deg)</label><input id="minProm" value="5.0"/></div>
          </div>
        </div>

        <div class="card half">
          <div style="font-weight:700;margin-bottom:8px;">Units</div>
          <div id="unitsList" class="grid" style="grid-template-columns:1fr;gap:8px"></div>
        </div>

        <div class="card half">
          <div style="font-weight:700;margin-bottom:8px;">Sync</div>
          <div class="grid">
            <div style="grid-column:1/-1">
              <label>Reference unit</label>
              <select id="syncRef"><option value="auto">Auto (first seen)</option></select>
            </div>
            <div>
              <label>Nearest tolerance (ms)</label>
              <input id="syncTol" type="number" value="120"/>
            </div>
          </div>
          <div class="small" id="syncInfo" style="margin-top:8px;"></div>
        </div>

        <div class="card grow"><div style="font-weight:700;margin-bottom:8px;">Logs</div><pre class="log" id="log"></pre></div>
      </div>
    </section>
  </div>

<script>
const APP_VERSION="v1.5.0 (2025-08-25)";
const ENCRYPTED_CREDS="eyJzYWx0IjoiYU01amVaRG9rd0o5dmVDc1gwTjhoQT09IiwiaXYiOiJuTEdVM2NldmhSSGFVR2ZmIiwiY3QiOiIzeVZaUkxnRUNxaWxicU92QmExZlJkcVZUb1ZiM3NvZFArd2svK3FxTW9NZGRYZHV5V2gveTV3WmVxakZlZkV6L2ZpZjN6SEpqU3Z0TXd2OCJ9";
const $=id=>document.getElementById(id);

// ---- utils ----
function log(s){const el=$('log');el.textContent+=s+"\\n";el.scrollTop=el.scrollHeight}
function setStatus(t,ok=false){$('status').textContent=t;$('status').className=ok?'ok':'bad'}
function meanStd(a){if(!a.length)return{mean:NaN,std:NaN};const m=a.reduce((x,y)=>x+y,0)/a.length;const v=a.reduce((x,y)=>x+(y-m)*(y-m),0)/a.length;return{mean:m,std:Math.sqrt(v)}}
function fmt2(n){return n.toString().padStart(2,'0')}
const b64d=b64=>Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
async function deriveKey(pw,salt){const enc=new TextEncoder();const mat=await crypto.subtle.importKey('raw',enc.encode(pw),'PBKDF2',false,['deriveKey']);return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:120000,hash:'SHA-256'},mat,{name:'AES-GCM',length:256},false,['encrypt','decrypt'])}
async function decryptCreds(pass,blob){const j=JSON.parse(atob(blob));const key=await deriveKey(pass,b64d(j.salt));const pt=await crypto.subtle.decrypt({name:'AES-GCM',iv:b64d(j.iv)},key,b64d(j.ct));return JSON.parse(new TextDecoder().decode(new Uint8Array(pt)))}

// GNSS guards
function coerceNum(v){
  if(v===null||v===undefined) return null;
  if(typeof v==='string'){
    const s=v.trim().toLowerCase();
    if(s===''||s==='null'||s==='nan'||s==='undefined') return null;
  }
  const n=Number(v);
  return Number.isFinite(n)? n : null;
}
function validLatLon(lat,lon){
  return lat!==null && lon!==null &&
         Number.isFinite(lat) && Number.isFinite(lon) &&
         Math.abs(lat)<=90 && Math.abs(lon)<=180;
}
// geo math
const Rm=6371000; // meters
function haversine(lat1,lon1,lat2,lon2){
  const toR=a=>a*Math.PI/180;
  const dlat=toR(lat2-lat1), dlon=toR(lon2-lon1);
  const a=Math.sin(dlat/2)**2 + Math.cos(toR(lat1))*Math.cos(toR(lat2))*(Math.sin(dlon/2)**2);
  return 2*Rm*Math.asin(Math.sqrt(a));
}
function bearingDeg(lat1,lon1,lat2,lon2){
  const toR=a=>a*Math.PI/180, toD=a=>a*180/Math.PI;
  const phi1=toR(lat1), phi2=toR(lat2), dlam=toR(lon2-lon1);
  const y=Math.sin(dlam)*Math.cos(phi2);
  const x=Math.cos(phi1)*Math.sin(phi2)-Math.sin(phi1)*Math.cos(phi2)*Math.cos(dlam);
  let brg=toD(Math.atan2(y,x));
  if(brg<0) brg+=360;
  return brg;
}

// chart defaults
Chart.defaults.color='#dfe7ff'; Chart.defaults.borderColor='#2a385a';

// ---- state ----
let client=null, unlocked=false, viewer={user:null,pass:null};
let chartTS=null, chartSOG=null;
let map=null, mapInited=false, firstMapFixDone=false;
let globalT0=null, syncLastMs=null;
const COLORS=["#4cc9f0","#ffd166","#ef476f","#06d6a0"];
const units={}, discoveredOrder=[];
const MAX_KEEP_SEC=600, FREQ_HOLD_MS=2000, GNSS_KEEP=4000;
const KNOTS_PER_MPS=1.94384449;

// sync
let syncRefMode='auto';
const syncRefSelect=$('syncRef');
function setSyncRefMode(val){ syncRefMode=val; $('syncInfo').textContent=`Reference: ${val}`; resetSyncSeries(); }
function getRefUnit(){ if(syncRefMode!=='auto' && units[syncRefMode]) return syncRefMode; return discoveredOrder.length? discoveredOrder[0] : null; }

// recording
let recActive=false, recRows=[], recStartedAt=null;

// DOM
const nowUnits=$('nowUnits'), statsUnits=$('statsUnits'), unitsList=$('unitsList');

// ---- charts & map ----
function makeTimeseries(){
  const ctx=document.getElementById('chart_ts').getContext('2d');
  return new Chart(ctx,{type:'line',data:{datasets:[]},options:{
    animation:false,responsive:true,maintainAspectRatio:false,
    scales:{x:{type:'linear',title:{display:true,text:'time (s from start)'},ticks:{callback:v=>Number(v).toFixed(1)}},y:{title:{display:true,text:'degrees'}}},
    plugins:{legend:{position:'bottom'}}
  }});
}
function makeSOG(){
  const ctx=document.getElementById('chart_sog').getContext('2d');
  return new Chart(ctx,{type:'line',data:{datasets:[]},options:{
    animation:false,responsive:true,maintainAspectRatio:false,
    scales:{x:{type:'linear',title:{display:true,text:'time (s from start)'},ticks:{callback:v=>Number(v).toFixed(1)}},
            y:{title:{display:true,text:'knots'}}},
    plugins:{legend:{position:'bottom'}}
  }});
}
function makeMap(){
  map = L.map('map',{zoomControl:true});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
    attribution:'&copy; OSM & CARTO', subdomains:'abcd', maxZoom:20
  }).addTo(map);
  map.setView([0,0], 2);
  mapInited=true;
}
function fitMapIfFirst(lat,lon){ if(!firstMapFixDone){ map.setView([lat,lon], 15); firstMapFixDone=true; } }

// ---- units ----
function ensureUnit(unitId){
  if(units[unitId]) return units[unitId];
  const color=COLORS[discoveredOrder.length%COLORS.length]; discoveredOrder.push(unitId);
  const opt=document.createElement('option'); opt.value=unitId; opt.textContent=unitId; syncRefSelect.appendChild(opt);

  const u=units[unitId]={color,visible:true,
    // raw arrivals (roll/pitch)
    times:[], roll:[], pitch:[],
    // synced series for plot
    seriesRoll:[], seriesPitch:[],
    // peak markers (style: circles)
    seriesRollPk:[], seriesPitchPk:[],
    // GNSS path + smoothing state
    gnssLatLngs:[],
    posEMA:null, prevPosEMA:null, prevPosTime:null, sogEMA:null, heading:null,
    // SOG series
    sogTimes:[], sogVals:[], sogSeries:[],
    // dataset idx
    idxRoll:null, idxPitch:null, idxRollPk:null, idxPitchPk:null,
    idxSOG:null,
    // map layers
    poly:null, marker:null,
    // now & stats els
    nowElems:{}, statsElems:{},
    // freq memory
    lastRollHz:NaN,lastRollAt:0,lastPitchHz:NaN,lastPitchAt:0
  };

  // timeseries datasets
  const rollDs={label:`${unitId} roll`,data:u.seriesRoll,parsing:false,borderColor:color,backgroundColor:'transparent',pointRadius:0,borderWidth:2,tension:.15,spanGaps:true};
  const pitchDs={label:`${unitId} pitch`,data:u.seriesPitch,parsing:false,borderColor:color,backgroundColor:'transparent',pointRadius:0,borderWidth:2,tension:.15,borderDash:[6,4],spanGaps:true};
  chartTS.data.datasets.push(rollDs); u.idxRoll=chartTS.data.datasets.length-1;
  chartTS.data.datasets.push(pitchDs); u.idxPitch=chartTS.data.datasets.length-1;

  // peak markers (small circles)
  const rollPk={label:`${unitId} roll peaks`,type:'scatter',data:u.seriesRollPk,parsing:false,backgroundColor:color,borderColor:color,pointRadius:4,pointStyle:'circle',showLine:false};
  const pitchPk={label:`${unitId} pitch peaks`,type:'scatter',data:u.seriesPitchPk,parsing:false,backgroundColor:color,borderColor:color,pointRadius:4,pointStyle:'circle',showLine:false};
  chartTS.data.datasets.push(rollPk); u.idxRollPk=chartTS.data.datasets.length-1;
  chartTS.data.datasets.push(pitchPk); u.idxPitchPk=chartTS.data.datasets.length-1;

  // SOG dataset
  const sogDs={label:`${unitId} SOG`,data:u.sogSeries,parsing:false,borderColor:color,backgroundColor:'transparent',pointRadius:0,borderWidth:2,tension:.15,spanGaps:true};
  chartSOG.data.datasets.push(sogDs); u.idxSOG=chartSOG.data.datasets.length-1;

  // map layers
  u.poly = L.polyline([], {color, weight:3, opacity:0.95}).addTo(map);
  u.marker = L.circleMarker([0,0], {radius:6, color, fillColor:color, fillOpacity:1}).addTo(map);
  u.poly.setStyle({opacity:0}); u.marker.setStyle({opacity:0, fillOpacity:0});

  // Now card
  const nowCard=document.createElement('div'); nowCard.className='unitNow uNums'; nowCard.style.setProperty('--ucolor',color);
  nowCard.innerHTML=`<div class="unitTag" style="background:${color}">${unitId}</div>
    <div class="grid">
      <div><div class="small">Roll</div><div class="num" id="now-roll-${unitId}">–</div></div>
      <div><div class="small">Pitch</div><div class="num" id="now-pitch-${unitId}">–</div></div>
      <div><div class="small">Freq (Hz)</div><div class="num" id="now-hz-${unitId}">–</div></div>
      <div><div class="small">SOG (kt)</div><div class="num" id="now-sog-${unitId}">–</div></div>
      <div><div class="small">Mean SOG (kt)</div><div class="num" id="now-sogmean-${unitId}">–</div></div>
      <div><div class="small">Heading (°)</div><div class="num" id="now-hdg-${unitId}">–</div></div>
      <div style="grid-column:1/-1"><div class="small">Lat, Lon</div><div class="small mono" id="now-ll-${unitId}">–</div></div>
    </div>`;
  nowUnits.appendChild(nowCard);
  u.nowElems={
    roll:$(`now-roll-${unitId}`),
    pitch:$(`now-pitch-${unitId}`),
    hz:$(`now-hz-${unitId}`),
    sog:$(`now-sog-${unitId}`),
    sogMean:$(`now-sogmean-${unitId}`),
    hdg:$(`now-hdg-${unitId}`),
    ll:$(`now-ll-${unitId}`)
  };

  // Stats card (add Mean SOG)
  const statsCol=document.createElement('div'); statsCol.className='card half unitStats'; statsCol.style.setProperty('--ucolor',color);
  statsCol.innerHTML=`<div style="font-weight:700;margin-bottom:8px;"><span class="unitTag" style="background:${color}">${unitId}</span> — window stats</div>
    <div class="grid">
      <div><div class="small">Mean Roll</div><div class="num" id="st-roll-mean-${unitId}">–</div></div>
      <div><div class="small">Std Roll</div><div class="num" id="st-roll-std-${unitId}">–</div></div>
      <div><div class="small">Mean Pitch</div><div class="num" id="st-pitch-mean-${unitId}">–</div></div>
      <div><div class="small">Std Pitch</div><div class="num" id="st-pitch-std-${unitId}">–</div></div>
      <div><div class="small">Peaks Roll</div><div class="num" id="st-roll-pk-${unitId}">0</div></div>
      <div><div class="small">Peaks Pitch</div><div class="num" id="st-pitch-pk-${unitId}">0</div></div>
      <div><div class="small">Freq Roll (Hz)</div><div class="num" id="st-roll-hz-${unitId}">–</div></div>
      <div><div class="small">Freq Pitch (Hz)</div><div class="num" id="st-pitch-hz-${unitId}">–</div></div>
      <div style="grid-column:1/-1"><div class="small">Mean SOG (kt)</div><div class="num" id="st-sog-mean-${unitId}">–</div></div>
    </div>`;
  statsUnits.appendChild(statsCol);
  u.statsElems={
    rMean:$(`st-roll-mean-${unitId}`), rStd:$(`st-roll-std-${unitId}`),
    pMean:$(`st-pitch-mean-${unitId}`), pStd:$(`st-pitch-std-${unitId}`),
    rPk:$(`st-roll-pk-${unitId}`), pPk:$(`st-pitch-pk-${unitId}`),
    rHz:$(`st-roll-hz-${unitId}`), pHz:$(`st-pitch-hz-${unitId}`),
    sogMean:$(`st-sog-mean-${unitId}`)
  };

  // settings checkbox controls all datasets + map
  const row=document.createElement('div');
  row.innerHTML=`<label style="display:flex;gap:8px;align-items:center">
    <input type="checkbox" id="chk-${unitId}" checked/>
    <span class="unitTag" style="background:${color}">${unitId}</span>
    <span class="tiny">show/hide</span></label>`;
  unitsList.appendChild(row);
  row.querySelector('input').addEventListener('change',(e)=>{
    u.visible=e.target.checked;
    [u.idxRoll,u.idxPitch,u.idxRollPk,u.idxPitchPk].forEach(i=>chartTS.data.datasets[i].hidden=!u.visible);
    chartSOG.data.datasets[u.idxSOG].hidden=!u.visible;
    if(u.visible){
      if(!map.hasLayer(u.poly)) u.poly.addTo(map);
      if(!map.hasLayer(u.marker)) u.marker.addTo(map);
      const hasFix = u.gnssLatLngs.length>0;
      u.poly.setStyle({opacity: hasFix?0.95:0});
      u.marker.setStyle({opacity: hasFix?1:0, fillOpacity: hasFix?1:0});
    }else{
      if(map.hasLayer(u.poly)) map.removeLayer(u.poly);
      if(map.hasLayer(u.marker)) map.removeLayer(u.marker);
    }
    chartTS.update('none'); chartSOG.update('none');
  });

  if(getRefUnit()===unitId && globalT0===null) resetSyncSeries();
  chartTS.update('none'); chartSOG.update('none');
  return u;
}

// nearest index
function nearestIdx(times,target){
  if(!times.length) return -1;
  let i=times.length-1;
  while(i>0 && times[i-1]>target) i--;
  const c1=i, c0=Math.max(0,i-1);
  const d1=Math.abs(times[c1]-target), d0=Math.abs(times[c0]-target);
  return (d1<=d0)?c1:c0;
}

// peaks
function detectPeaks(vals,times,minDistMs,minProm){
  const n=vals.length; if(n<3) return [];
  const peaks=[]; let lastT=-1e18;
  for(let i=1;i<n-1;i++){
    const v=vals[i]; if(v<=vals[i-1]||v<=vals[i+1]) continue;
    const w=5, i0=Math.max(0,i-w), i1=Math.min(n-1,i+w);
    let base=vals[i0]; for(let j=i0+1;j<=i1;j++) base=Math.min(base,vals[j]);
    if(v-base<minProm) continue;
    const t=times[i]; if(t-lastT<minDistMs) continue;
    peaks.push({t,v,i}); lastT=t;
  } return peaks;
}

// windows & axes
const viewRange=$('viewSecRange'), viewNum=$('viewSec'); let currentViewSec=parseInt(viewNum.value||'10',10);
function applyViewWindow(val){currentViewSec=Math.max(5,Math.min(600,parseInt(val||'10',10)));viewRange.value=currentViewSec;viewNum.value=currentViewSec;updateAxisRange()}
viewRange.addEventListener('input',e=>applyViewWindow(e.target.value)); viewNum.addEventListener('change',e=>applyViewWindow(e.target.value));

const winRange=$('winSecRange'), winNum=$('winSec');
function applyWindow(val){const v=Math.max(5,Math.min(600,parseInt(val||'10',10))); winRange.value=v; winNum.value=v; const now=syncLastMs||Date.now(); recomputePeaksAndStatsAll(now); chartTS.update('none'); chartSOG.update('none');}
winRange.addEventListener('input',e=>applyWindow(e.target.value)); winNum.addEventListener('change',e=>applyWindow(e.target.value));

function updateAxisRange(){
  if(globalT0===null){ if(chartTS){chartTS.options.scales.x.min=0;chartTS.options.scales.x.max=currentViewSec;chartTS.update('none');}
                        if(chartSOG){chartSOG.options.scales.x.min=0;chartSOG.options.scales.x.max=currentViewSec;chartSOG.update('none');}
                        return; }
  const last = syncLastMs || Date.now();
  const nowSec=(last-globalT0)/1000;
  const xmin=Math.max(0,nowSec-currentViewSec), xmax=Math.max(currentViewSec,nowSec);
  if(chartTS){chartTS.options.scales.x.min=Number(xmin.toFixed(1)); chartTS.options.scales.x.max=Number(xmax.toFixed(1)); chartTS.update('none');}
  if(chartSOG){chartSOG.options.scales.x.min=Number(xmin.toFixed(1)); chartSOG.options.scales.x.max=Number(xmax.toFixed(1)); chartSOG.update('none');}
}

// prune old
function pruneOld(nowMs){
  const keepMs=Math.max(parseFloat(winNum.value||'10')*1000,MAX_KEEP_SEC*1000);
  for(const id of Object.keys(units)){
    const u=units[id];
    // raw roll/pitch arrivals
    while(u.times.length && u.times[0]<nowMs-keepMs){u.times.shift();u.roll.shift();u.pitch.shift();}
    // plotted series (roll/pitch)
    while(u.seriesRoll.length && (globalT0 + u.seriesRoll[0].x*1000) < nowMs-keepMs){u.seriesRoll.shift();u.seriesPitch.shift();}
    // GNSS path length cap
    while(u.gnssLatLngs.length>GNSS_KEEP){u.gnssLatLngs.shift(); if(u.poly) u.poly.setLatLngs(u.gnssLatLngs);}
    // SOG
    while(u.sogTimes.length && u.sogTimes[0]<nowMs-keepMs){u.sogTimes.shift();u.sogVals.shift();}
    while(u.sogSeries.length && (globalT0 + u.sogSeries[0].x*1000) < nowMs-keepMs){u.sogSeries.shift();}
  }
}

// stats (incl. mean SOG)
function recomputePeaksAndStatsAll(){
  const winSec=parseFloat(winNum.value||'10'), minDist=parseFloat($('minDist').value||'300'), minProm=parseFloat($('minProm').value||'5.0');
  for(const id of Object.keys(units)){
    const u=units[id]; if(!u.times.length) continue;
    const nowU=u.times[u.times.length-1]; const startMs=nowU - winSec*1000;
    let s=0; while(s<u.times.length && u.times[s]<startMs) s++;
    const tWin=u.times.slice(s), rWin=u.roll.slice(s), pWin=u.pitch.slice(s);

    const rPeaks=detectPeaks(rWin,tWin,minDist,minProm);
    const pPeaks=detectPeaks(pWin,tWin,minDist,minProm);

    u.seriesRollPk.length=0; u.seriesPitchPk.length=0;
    for(const pk of rPeaks){u.seriesRollPk.push({x:(pk.t-globalT0)/1000,y:pk.v});}
    for(const pk of pPeaks){u.seriesPitchPk.push({x:(pk.t-globalT0)/1000,y:pk.v});}

    function freq(peaks){ if(peaks.length<2) return NaN; let s=0,c=0; for(let i=1;i<peaks.length;i++){const dt=(peaks[i].t-peaks[i-1].t)/1000; if(dt>0){s+=dt;c++;}} return c?1/(s/c):NaN; }
    const fR=freq(rPeaks), fP=freq(pPeaks);
    if(Number.isFinite(fR)){u.lastRollHz=fR;u.lastRollAt=nowU;}
    if(Number.isFinite(fP)){u.lastPitchHz=fP;u.lastPitchAt=nowU;}
    const fShowR=(Number.isFinite(u.lastRollHz)&&(nowU-(u.lastRollAt||0)<FREQ_HOLD_MS))?u.lastRollHz:(Number.isFinite(fR)?fR:NaN);
    const fShowP=(Number.isFinite(u.lastPitchHz)&&(nowU-(u.lastPitchAt||0)<FREQ_HOLD_MS))?u.lastPitchHz:(Number.isFinite(fP)?fP:NaN);

    const rs=meanStd(rWin), ps=meanStd(pWin);
    if(u.statsElems.rMean) u.statsElems.rMean.textContent=isFinite(rs.mean)?rs.mean.toFixed(2):'–';
    if(u.statsElems.rStd)  u.statsElems.rStd.textContent =isFinite(rs.std)? rs.std.toFixed(2) :'–';
    if(u.statsElems.pMean) u.statsElems.pMean.textContent=isFinite(ps.mean)?ps.mean.toFixed(2):'–';
    if(u.statsElems.pStd)  u.statsElems.pStd.textContent =isFinite(ps.std)? ps.std.toFixed(2) :'–';
    if(u.statsElems.rPk)   u.statsElems.rPk.textContent  =rPeaks.length;
    if(u.statsElems.pPk)   u.statsElems.pPk.textContent  =pPeaks.length;
    if(u.statsElems.rHz)   u.statsElems.rHz.textContent  =isFinite(fShowR)?fShowR.toFixed(2):'–';
    if(u.statsElems.pHz)   u.statsElems.pHz.textContent  =isFinite(fShowP)?fShowP.toFixed(2):'–';

    // Mean SOG over window (arrival-time)
    let sIdx=0; while(sIdx<u.sogTimes.length && u.sogTimes[sIdx]<startMs) sIdx++;
    const sogWin=u.sogVals.slice(sIdx);
    const sogStats=meanStd(sogWin);
    if(u.statsElems.sogMean) u.statsElems.sogMean.textContent=isFinite(sogStats.mean)?sogStats.mean.toFixed(2):'–';
    if(u.nowElems.sogMean)   u.nowElems.sogMean.textContent  =isFinite(sogStats.mean)?sogStats.mean.toFixed(2):'–';

    // Show Hz in Now tile (same logic as before)
    const fNow = Number.isFinite(fShowR)?fShowR:(Number.isFinite(fShowP)?fShowP:NaN);
    if(u.nowElems.hz) u.nowElems.hz.textContent = isFinite(fNow)? fNow.toFixed(2):'–';
  }
}

// ---- synced plotting (arrival-time ZOH) ----
function resetSyncSeries(){
  syncLastMs=null;
  let tfirst=null;
  for(const id of Object.keys(units)){ if(units[id].times.length){ tfirst = (tfirst===null)? units[id].times[0] : Math.min(tfirst, units[id].times[0]); } }
  if(tfirst!==null) globalT0=tfirst;
  for(const id of Object.keys(units)){ units[id].seriesRoll.length=0; units[id].seriesPitch.length=0; }
  chartTS.update('none'); updateAxisRange(); log(`sync reset → ref=${getRefUnit()||'none'}`);
}
function appendSyncedPoint(t_ref){
  if(globalT0===null) globalT0=t_ref;
  const tol=parseFloat($('syncTol').value||'120');
  const x=(t_ref-globalT0)/1000;

  for(const id of Object.keys(units)){
    const u=units[id];
    const idx=nearestIdx(u.times,t_ref);
    let yR=null,yP=null;
    if(idx>=0 && Math.abs(u.times[idx]-t_ref)<=tol){
      yR=u.roll[idx]; yP=u.pitch[idx];
    } else {
      const lastPlottedR = u.seriesRoll.length ? u.seriesRoll[u.seriesRoll.length-1].y : null;
      const lastPlottedP = u.seriesPitch.length? u.seriesPitch[u.seriesPitch.length-1].y: null;
      const lastRawR = u.roll.length ? u.roll[u.roll.length-1] : null;
      const lastRawP = u.pitch.length? u.pitch[u.pitch.length-1]: null;
      yR = (lastPlottedR!=null) ? lastPlottedR : (lastRawR!=null ? lastRawR : null);
      yP = (lastPlottedP!=null) ? lastPlottedP : (lastRawP!=null ? lastRawP : null);
      if(yR===null && yP===null) continue;
    }
    u.seriesRoll.push({x,y:yR});
    u.seriesPitch.push({x,y:yP});
  }

  syncLastMs=t_ref;
  pruneOld(t_ref);
  recomputePeaksAndStatsAll();
  updateAxisRange();
  chartTS.update('none');
  chartSOG.update('none');
}

// ---- SOG/heading update from GNSS (EMA smoothing) ----
function updateSOGandHeading(u, t, lat, lon){
  const alphaPos=0.25;          // EMA on position
  const alphaSOG=0.3;           // EMA on speed
  if(u.posEMA==null){ u.posEMA={lat,lon}; u.prevPosEMA={lat,lon}; u.prevPosTime=t; return; }
  // update EMA position
  const newLat = u.posEMA.lat*(1-alphaPos) + lat*alphaPos;
  const newLon = u.posEMA.lon*(1-alphaPos) + lon*alphaPos;
  const dt = (t - (u.prevPosTime||t))/1000; // seconds
  if(dt<=0){ u.posEMA={lat:newLat,lon:newLon}; u.prevPosEMA={lat:newLat,lon:newLon}; u.prevPosTime=t; return; }

  const dist = haversine(u.prevPosEMA.lat, u.prevPosEMA.lon, newLat, newLon); // meters
  const spd_mps = dist/dt;
  const spd_kt_raw = spd_mps * KNOTS_PER_MPS;
  u.sogEMA = (u.sogEMA==null) ? spd_kt_raw : (u.sogEMA*(1-alphaSOG) + spd_kt_raw*alphaSOG);

  // heading only if SOG > 2 kt
  if(u.sogEMA>2){
    u.heading = bearingDeg(u.prevPosEMA.lat, u.prevPosEMA.lon, newLat, newLon);
  } else {
    u.heading = null;
  }

  // store for next
  u.posEMA = {lat:newLat, lon:newLon};
  u.prevPosEMA = {lat:newLat, lon:newLon};
  u.prevPosTime = t;

  // append to SOG arrays / series
  const x=(t-globalT0)/1000;
  u.sogTimes.push(t);
  u.sogVals.push(u.sogEMA);
  u.sogSeries.push({x, y:u.sogEMA});
}

// ---- Recording buttons ----
const btnRecord=$('btnRecord'), recInfo=$('recInfo');
btnRecord.addEventListener('click',()=>{ if(!recActive){ startRec(); } else { stopRec(); } });
function startRec(){ recActive=true; recRows=[]; recStartedAt=Date.now(); btnRecord.textContent="Stop & Save"; btnRecord.classList.add('recording','blink'); if(window._rt) clearInterval(window._rt); window._rt=setInterval(()=>{recInfo.textContent=`Recording… ${((Date.now()-recStartedAt)/1000).toFixed(1)} s`;},200); log("recording started"); }
function stopRec(){
  recActive=false; btnRecord.textContent="Start Recording"; btnRecord.classList.remove('recording','blink'); if(window._rt){clearInterval(window._rt);window._rt=null;}
  if(!recRows.length){recInfo.textContent="No samples recorded.";log("no samples to save");return;}
  const header=['unit_id','timestamp_ms','iso_time','elapsed_s','seq','roll_deg','pitch_deg','lat','lon','gnss_ms','gnss_iso'];
  const lines=[header.join(',')];
  for(const r of recRows){
    const iso=new Date(r.t).toISOString();
    lines.push([r.unit,r.t,`"${iso.replace(/"/g,'""')}"`,
                (globalT0!==null?((r.t-globalT0)/1000).toFixed(3):''),
                (r.seq??''),r.roll.toFixed(6),r.pitch.toFixed(6),
                (Number.isFinite(r.lat)?r.lat.toFixed(6):''),(Number.isFinite(r.lon)?r.lon.toFixed(6):''),
                (r.gnss_ms??''), r.gnss_iso?`"${r.gnss_iso}"`:''].join(','));
  }
  const csv=lines.join('\n'), blob=new Blob([csv],{type:'text/csv'}), d=new Date(recStartedAt||Date.now());
  const fname=`trollsports_multi_${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())}_${fmt2(d.getHours())}-${fmt2(d.getMinutes())}-${fmt2(d.getSeconds())}.csv`;
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fname; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},1000);
  recInfo.textContent=`Saved ${recRows.length} samples to ${fname}`; log(`saved CSV (${recRows.length} rows)`);
}

// ---- Tabs ----
document.querySelectorAll('.tabbtn').forEach(b=>b.addEventListener('click',()=>{
  const name=b.dataset.tab; ['plot','stats','settings'].forEach(t=>document.getElementById('tab-'+t).classList.add('hidden'));
  document.getElementById('tab-'+name).classList.remove('hidden');
  document.querySelectorAll('.tabbtn').forEach(x=>x.classList.toggle('active',x.dataset.tab===name));
}));

// ---- Unlock & connect ----
document.getElementById('btnUnlock').addEventListener('click',async ()=>{
  const pwd=document.getElementById('pw').value; if(!pwd){document.getElementById('unlockMsg').textContent='Enter a password.';return;}
  if(!ENCRYPTED_CREDS||ENCRYPTED_CREDS==='PASTE_CIPHERTEXT_HERE'){ document.getElementById('unlockMsg').textContent='No encrypted creds embedded.'; return; }
  try{
    const creds=await decryptCreds(pwd,ENCRYPTED_CREDS);
    viewer.user=creds.user; viewer.pass=creds.pass; unlocked=true;
    document.getElementById('gate').classList.add('hidden'); document.getElementById('app').classList.remove('hidden');
    document.getElementById('cid').value='web-'+Math.random().toString(16).slice(2,10);
    chartTS=makeTimeseries(); chartSOG=makeSOG(); makeMap();
    setStatus('unlocked — not connected',false);
    applyWindow(document.getElementById('winSec').value); applyViewWindow(document.getElementById('viewSec').value);
    syncRefSelect.addEventListener('change', e=>setSyncRefMode(e.target.value));
    if(document.getElementById('autoconn').checked) connect();
  }catch(e){ document.getElementById('unlockMsg').textContent='Wrong password or corrupted ciphertext.'; }
});

function connect(){
  if(!unlocked) return;
  if(client){ try{client.end(true);}catch(e){} client=null; }
  const host=document.getElementById('host').value.trim(), port=document.getElementById('port').value.trim(), path=document.getElementById('path').value.trim()||'/mqtt';
  const topic=document.getElementById('topic').value.trim(), cid=document.getElementById('cid').value||('web-'+Math.random().toString(16).slice(2,10));
  document.getElementById('cid').value=cid; const url=`wss://${host}:${port}${path}`; document.getElementById('url').textContent=url;

  client=mqtt.connect(url,{protocolVersion:4,clean:true,connectTimeout:8000,username:viewer.user,password:viewer.pass,clientId:cid,keepalive:30,resubscribe:true});
  client.on('connect',()=>{setStatus('connected',true);client.subscribe(topic,{qos:0});log('connected & subscribed: '+topic);});
  client.on('reconnect',()=>{setStatus('reconnecting…',false);log('reconnecting');});
  client.on('close',()=>{setStatus('disconnected',false);log('closed');});
  client.on('error',e=>{setStatus('error',false);log('error: '+(e?.message||e));});
  client.on('message',(topic,payload)=>{
    try{
      const t = Date.now();
      let txt; try{txt=new TextDecoder().decode(payload);}catch{txt=payload.toString?payload.toString():'';}
      const d=JSON.parse(txt);
      let unit=d.unit_id; if(!unit){const m=topic.split('/'); if(m.length>=3) unit=m[1];}
      if(!unit) unit='unknown';
      if(globalT0===null) globalT0=t;

      const u=ensureUnit(unit);
      let roll=d.roll_deg, pitch=d.pitch_deg;
      if((roll===undefined||pitch===undefined)&&d.ax!==undefined){
        const k=180/Math.PI; roll=Math.atan2(d.ay,d.az)*k; pitch=Math.atan2(-d.ax,Math.sqrt(d.ay*d.ay+d.az*d.az))*k;
      }
      if(typeof roll!=='number'||typeof pitch!=='number'){log('msg missing roll/pitch: '+txt);return;}

      // raw arrival buffers
      u.times.push(t); u.roll.push(roll); u.pitch.push(pitch);
      if(u.nowElems.roll) u.nowElems.roll.textContent=roll.toFixed(2);
      if(u.nowElems.pitch)u.nowElems.pitch.textContent=pitch.toFixed(2);

      // robust GNSS
      const lat = coerceNum(d.lat);
      const lon = coerceNum(d.lon);
      const hasFix = validLatLon(lat,lon);

      // map & SOG/heading
      if(hasFix){
        // map path & marker
        u.gnssLatLngs.push([lat,lon]);
        if(u.gnssLatLngs.length>GNSS_KEEP) u.gnssLatLngs.shift();
        u.poly.setLatLngs(u.gnssLatLngs);
        u.poly.setStyle({opacity: u.visible?0.95:0});
        u.marker.setLatLng([lat,lon]);
        u.marker.setStyle({opacity: u.visible?1:0, fillOpacity: u.visible?1:0});
        if(!firstMapFixDone) fitMapIfFirst(lat,lon);
        if(u.nowElems.ll) u.nowElems.ll.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;

        // SOG & heading (EMA)
        updateSOGandHeading(u, t, lat, lon);
        if(u.nowElems.sog) u.nowElems.sog.textContent = (u.sogEMA!=null)? u.sogEMA.toFixed(2) : '–';
        if(u.nowElems.hdg) u.nowElems.hdg.textContent = (u.heading!=null)? u.heading.toFixed(0) : '–';
      }else{
        if(u.nowElems.ll) u.nowElems.ll.textContent = '–';
      }

      // record if active
      if(recActive){
        recRows.push({
          unit, t, seq:d.seq, roll, pitch,
          lat: (hasFix?lat:undefined),
          lon: (hasFix?lon:undefined),
          gnss_ms: (d.gnss_ms===null||d.gnss_ms===undefined)? undefined : d.gnss_ms,
          gnss_iso: (d.gnss_iso||'')
        });
      }

      // synced roll/pitch plot driven by ref unit
      const ref=getRefUnit();
      if(ref===unit){ appendSyncedPoint(t); }

      // update SOG chart live
      chartSOG.update('none');

      // refresh stats (includes Mean SOG)
      recomputePeaksAndStatsAll();
      updateAxisRange();

    }catch(e){log('parse error: '+e);}
  });
}

function disconnect(){ if(client){try{client.end(true);}catch(e){} client=null;} setStatus('disconnected',false); log('disconnected'); }
document.getElementById('btnConnect').addEventListener('click',connect);
document.getElementById('btnDisconnect').addEventListener('click',disconnect);
document.getElementById('btnClear').addEventListener('click',()=>{
  for(const id of Object.keys(units)){
    const u=units[id];
    u.times.length=0;u.roll.length=0;u.pitch.length=0;
    u.seriesRoll.length=0;u.seriesPitch.length=0;u.seriesRollPk.length=0;u.seriesPitchPk.length=0;
    u.gnssLatLngs.length=0; u.poly.setLatLngs([]); u.poly.setStyle({opacity:0}); u.marker.setStyle({opacity:0, fillOpacity:0});
    u.posEMA=null; u.prevPosEMA=null; u.prevPosTime=null; u.sogEMA=null; u.heading=null;
    u.sogTimes.length=0; u.sogVals.length=0; u.sogSeries.length=0;
    [u.idxRoll,u.idxPitch,u.idxRollPk,u.idxPitchPk].forEach(i=>chartTS.data.datasets[i].hidden=false);
    chartSOG.data.datasets[u.idxSOG].hidden=false;
  }
  globalT0=null; syncLastMs=null; chartTS.update('none'); chartSOG.update('none'); log('cleared');
  firstMapFixDone=false; if(mapInited) map.setView([0,0],2);
});

// keep axes tight to window
setInterval(updateAxisRange, 500);
</script>
</body>
</html>
